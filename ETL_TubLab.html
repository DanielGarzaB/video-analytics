<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Guia practica ETL TubLab</title>
  <style>
    :root {
      --bg: #f6f7fb;
      --surface: #ffffff;
      --ink: #0f172a;
      --muted: #556074;
      --accent: #0ea5e9;
      --accent-2: #10b981;
      --border: #e2e8f0;
      --code-bg: #0b1220;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI Variable", "Segoe UI", "Noto Sans", "Helvetica Neue", sans-serif;
      background: radial-gradient(120% 100% at 20% 0%, #e0f2fe 0%, rgba(224,242,254,0) 50%),
                  radial-gradient(140% 120% at 85% 10%, #d1fae5 0%, rgba(209,250,229,0) 52%),
                  var(--bg);
      color: var(--ink);
      line-height: 1.6;
      padding: 32px 0 56px;
    }
    ::selection { background: rgba(14,165,233,0.2); }
    .page { max-width: 1100px; margin: 0 auto; padding: 0 22px; }
    article.doc {
      background: var(--surface);
      padding: 32px;
      border-radius: 18px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 60px rgba(15, 23, 42, 0.08);
    }
    article.doc h1 {
      margin-top: 0;
      font-size: 34px;
      letter-spacing: -0.01em;
      display: flex;
      gap: 12px;
      align-items: center;
    }
    article.doc h2 { margin-top: 32px; color: var(--ink); }
    article.doc h3 { margin-top: 24px; color: var(--ink); }
    article.doc h2, article.doc h3 {
      position: relative;
      padding-left: 8px;
    }
    article.doc h2::before, article.doc h3::before {
      content: "";
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 70%;
      border-radius: 8px;
      background: linear-gradient(180deg, var(--accent), var(--accent-2));
    }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    p { color: var(--muted); }
    ul { padding-left: 22px; }
    li { margin: 6px 0; }
    blockquote {
      margin: 16px 0;
      padding: 12px 16px;
      border-left: 4px solid var(--accent);
      background: #f0f9ff;
      color: var(--ink);
      border-radius: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 14px 0 18px;
      background: #fbfdff;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }
    th, td {
      border-bottom: 1px solid var(--border);
      padding: 12px 14px;
      text-align: left;
      vertical-align: top;
    }
    th { background: #e0f2fe; color: #0f172a; font-weight: 700; }
    tr:nth-child(even) td { background: #f8fafc; }
    code {
      background: #e2e8f0;
      color: #0f172a;
      padding: 2px 5px;
      border-radius: 6px;
      font-family: "JetBrains Mono", "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
      font-size: 0.95em;
    }
    pre {
      background: var(--code-bg);
      color: #e5e7eb;
      border-radius: 14px;
      padding: 18px 16px 16px;
      padding-right: 54px;
      overflow: auto;
      border: 1px solid #111827;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
      position: relative;
    }
    pre code {
      background: transparent;
      color: inherit;
      padding: 0;
      font-size: 0.95em;
      display: block;
      line-height: 1.5;
    }
    .tok-kw { color: #7dd3fc; }
    .tok-fn { color: #a5b4fc; }
    .tok-str { color: #f9a8d4; }
    .tok-num { color: #fcd34d; }
    .tok-cmt { color: #94a3b8; font-style: italic; }
    .tok-op { color: #c084fc; }
    .tok-var { color: #c7d2fe; }
    hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 28px 0;
    }
    .toc-list {
      list-style: decimal;
      padding-left: 22px;
      margin: 0;
    }
    .toc-list li { margin: 6px 0 10px; }
    .toc-list li a { font-weight: 700; color: var(--ink); text-decoration: none; }
    .toc-sub {
      margin: 8px 0 0;
      padding-left: 18px;
      color: var(--muted);
      list-style: disc;
    }
    .toc-sub li { margin: 4px 0; }
    .hero {
      background: linear-gradient(120deg, rgba(14,165,233,0.15), rgba(16,185,129,0.18));
      border: 1px solid var(--border);
      padding: 22px 22px 26px;
      border-radius: 16px;
      margin-bottom: 28px;
      position: relative;
      overflow: hidden;
    }
    .hero::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(60% 80% at 90% 10%, rgba(255,255,255,0.55), transparent);
      pointer-events: none;
    }
    .hero h1 { margin: 8px 0 6px; position: relative; z-index: 1; }
    .hero .lede { margin: 0; color: var(--ink); max-width: 820px; position: relative; z-index: 1; }
    .pill-row { display: flex; flex-wrap: wrap; gap: 8px; position: relative; z-index: 1; }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 600;
      color: var(--ink);
      background: rgba(255,255,255,0.7);
      border: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
    }
    .pill.success { color: #0f5132; background: #d1fae5; border-color: #bbf7d0; }
    .pill.neutral { color: #0f172a; background: #e0f2fe; border-color: #bae6fd; }
    .hero-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 10px;
      position: relative;
      z-index: 1;
    }
    .meta-card {
      background: rgba(255,255,255,0.85);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      min-width: 170px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
    }
    .meta-card .label { color: var(--muted); font-size: 13px; }
    .meta-card .value { font-weight: 700; color: var(--ink); }
    .toc-card {
      background: #f8fafc;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px 18px 2px;
      margin-bottom: 18px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.4);
    }
    .toc-card h2 { margin-top: 0; }
    pre .copy-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.08);
      color: #e5e7eb;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      transition: all 120ms ease;
    }
    pre .copy-btn:hover {
      background: rgba(255,255,255,0.15);
      transform: translateY(-1px);
    }
    pre .copy-btn.copied {
      background: #22c55e;
      color: #0b141f;
      border-color: #16a34a;
    }
    @media (max-width: 700px) {
      body { padding: 20px 0 36px; }
      article.doc { padding: 24px; }
      article.doc h1 { font-size: 28px; }
      .hero { padding: 18px; }
      .meta-card { min-width: 0; flex: 1 1 140px; }
    }
  </style>
</head>
<body>
  <div class="page">
    <article class="doc">
      <section class="hero">
        <div class="pill-row">
          <span class="pill neutral">TubLab</span>
          <span class="pill neutral">Video Gallery</span>
          <span class="pill success">CSV listo</span>
        </div>
        <h1 id="guia-practica-extraer-datos-de-tublab-video-gallery">üé¨ Guia practica: extraer datos de TubLab (Video Gallery)</h1>
        <p class="lede">Objetivo: automatizar los clics en "Load more" y exportar la tabla de Video Gallery a CSV con: <code>video</code>, <code>creator_name</code>, <code>video_url</code>, <code>image_url</code>, <code>upload_date</code>, <code>views</code>, <code>v30</code>, <code>duration</code>, <code>platform</code> + columnas normalizadas (<code>views_num</code>, <code>v30_num</code>, <code>duration_sec</code>).</p>
        <div class="hero-meta">
          <div class="meta-card">
            <div class="label">Salida</div>
            <div class="value">CSV + portapapeles</div>
          </div>
          <div class="meta-card">
            <div class="label">Metricas</div>
            <div class="value">views_num | v30_num | duration_sec</div>
          </div>
          <div class="meta-card">
            <div class="label">Carga</div>
            <div class="value">Auto "Load more" (max 500 clics)</div>
          </div>
        </div>
      </section>
      <section class="toc-card">
        <h2 id="indice-rapido">Indice rapido</h2>
        <ol class="toc-list">
          <li><a href="#requisitos-previos">Requisitos previos</a></li>
          <li><a href="#tabla-de-parametros">Tabla de parametros</a></li>
          <li>
            <a href="#opcion-a-scripts-separados">Opcion A: scripts separados</a>
            <ul class="toc-sub">
              <li><a href="#paso-1-auto-load-more">Paso 1: auto clic en "Load more"</a></li>
              <li><a href="#paso-2-extraer-csv">Paso 2: extraer y descargar CSV</a></li>
            </ul>
          </li>
          <li><a href="#opcion-b-todo-en-uno">Opcion B: todo en uno</a></li>
          <li><a href="#diagnostico-rapido">Diagnostico rapido</a></li>
          <li><a href="#guia-rapida-de-uso">Guia rapida de uso</a></li>
          <li><a href="#solucion-de-problemas">Solucion de problemas</a></li>
          <li><a href="#notas-de-mantenimiento">Notas de mantenimiento</a></li>
        </ol>
      </section>
<hr />
<p><a id="requisitos-previos"></a></p>
<h2 id="requisitos-previos">‚úÖ Requisitos previos</h2>
<table>
<thead>
<tr>
<th>Requisito</th>
<th>Detalle</th>
</tr>
</thead>
<tbody>
<tr>
<td>Navegador</td>
<td>Chrome o Edge (Chromium)</td>
</tr>
<tr>
<td>Herramienta</td>
<td>DevTools Console (F12 -&gt; Console)</td>
</tr>
<tr>
<td>Permiso</td>
<td>Escribir <code>allow pasting</code> + Enter antes de pegar codigo</td>
</tr>
<tr>
<td>Pagina</td>
<td>Estar en la vista &quot;Video Gallery&quot; de TubLab</td>
</tr>
</tbody>
</table>
<hr />
<p><a id="tabla-de-parametros"></a></p>
<h2 id="tabla-de-parametros">üìä Tabla de parametros</h2>
<table>
<thead>
<tr>
<th>Parametro</th>
<th>Tipo</th>
<th>Default</th>
<th>Descripcion</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>maxClicks</code></td>
<td>number</td>
<td>500</td>
<td>Maximo de clics en &quot;Load more&quot; antes de parar</td>
</tr>
<tr>
<td><code>delayMs</code></td>
<td>number</td>
<td>6000</td>
<td>Milisegundos base de espera entre cada clic</td>
</tr>
<tr>
<td><code>delayJitterMs</code></td>
<td>number</td>
<td>300</td>
<td>Jitter aleatorio (0-<code>delayJitterMs</code>) para que parezca humano (recomendado 300-500 ms)</td>
</tr>
<tr>
<td><code>finalDelay</code></td>
<td>number</td>
<td>3000</td>
<td>Espera final antes de leer la tabla</td>
</tr>
<tr>
<td><code>normalizeNumbers</code></td>
<td>boolean</td>
<td>true</td>
<td>Convertir vistas (K/M/B) a numero y duracion a segundos</td>
</tr>
<tr>
<td><code>downloadFile</code></td>
<td>boolean</td>
<td>true</td>
<td><code>true</code> = descarga CSV, <code>false</code> = solo portapapeles</td>
</tr>
<tr>
<td><code>promptFileName</code></td>
<td>boolean</td>
<td>false</td>
<td><code>false</code> = nombre auto <code>TubLab_yy_mm_dd_HHmmss.csv</code></td>
</tr>
<tr>
<td><code>fileNamePrefix</code></td>
<td>string</td>
<td><code>TubLab_Videos</code></td>
<td>Prefijo para el CSV exportado</td>
</tr>
</tbody>
</table>
<hr />
<p><a id="opcion-a-scripts-separados"></a></p>
<h2 id="opcion-a-scripts-separados">üÖ∞Ô∏è Opcion A: scripts separados</h2>
<p><a id="paso-1-auto-load-more"></a></p>
<h3 id="paso-1-auto-clic-en-load-more-selector-especifico-jitter-humano">Paso 1: auto clic en &quot;Load more&quot; (selector especifico + jitter humano)</h3>
<pre><code class="language-js">(() =&gt; {
  // CONFIGURACION
  const AUTO_CONFIG = {
    maxClicks: 500,
    delayMs: 6000,      // base
    delayJitterMs: 500, // aleatorio 0-500 ms
    finalDelay: 3000,
    autoStart: true     // true = arranca al pegar; false = manual con await autoLoadMore()
  };

  // Selectores ajustados a tu HTML
  const LOAD_MORE_SELECTORS = [
    '.button.full-width[ng-click*=&quot;loadMore&quot;]', // especifico
    '.load-more .button',
    '[ng-click*=&quot;loadMore&quot;]',
    '.button:contains(&quot;Load more&quot;)'
  ];

  const sleep = (ms) =&gt; new Promise(r =&gt; setTimeout(r, ms));

  function findButton() {
    for (const sel of LOAD_MORE_SELECTORS) {
      const el = document.querySelector(sel);
      if (el &amp;&amp; el.offsetParent !== null) return el;
    }
    return null;
  }

  window.autoLoadMore = async function(customOptions = {}) {
    const opts = { ...AUTO_CONFIG, ...customOptions };
    console.log(&quot;[AUTO] Iniciando auto-clic...&quot;, opts);

    let clickCount = 0;

    for (let i = 0; i &lt; opts.maxClicks; i++) {
      const btn = findButton();

      if (!btn) {
        console.log(&quot;[STOP] Bot√≥n 'Load more' no encontrado o invisible. Terminando.&quot;);
        break;
      }

      btn.scrollIntoView({ block: &quot;center&quot;, behavior: &quot;instant&quot; });
      btn.click();
      clickCount++;

      const jitter = Math.floor(Math.random() * ((opts.delayJitterMs || 0) + 1));
      const totalWait = opts.delayMs + jitter;
      if (clickCount % 10 === 0) console.log(`[CLIC] Clic #${clickCount} (Espera: ${totalWait}ms)`);

      await sleep(totalWait);
    }

    console.log(`[OK] Finalizado. Total clics: ${clickCount}. Esperando render final...`);
    await sleep(opts.finalDelay);
    console.log(&quot;[LISTO] Listo para extraer.&quot;);
  };

  if (AUTO_CONFIG.autoStart) {
    console.log(&quot;[OK] Script de clic cargado. Iniciando...&quot;);
    autoLoadMore().catch((err) =&gt; console.error(&quot;[ERROR] autoLoadMore fallo:&quot;, err));
  } else {
    console.log(&quot;[OK] Script de clic cargado. Escribe: await autoLoadMore();&quot;);
  }
})();
</code></pre>
<blockquote>
<p>Si ves <code>undefined</code> en consola despues de pegar el bloque, es normal: es el retorno de la IIFE (no devuelve nada). Si prefieres control manual, pon <code>autoStart: false</code> y luego ejecuta <code>await autoLoadMore();</code>.</p>
</blockquote>
<p><a id="paso-2-extraer-csv"></a></p>
<h3 id="paso-2-extraer-y-descargar-csv-miniaturas-corregidas">Paso 2: extraer y descargar CSV (miniaturas corregidas)</h3>
<pre><code class="language-js">(() =&gt; {
  const EXTRACT_CONFIG = {
    normalizeNumbers: true,
    downloadFile: true,
    fileNamePrefix: &quot;TubLab_Videos&quot;
  };

  const csvEscape = (val) =&gt; '&quot;' + String(val || &quot;&quot;).replace(/&quot;/g, '&quot;&quot;') + '&quot;';

  const parseViews = (txt) =&gt; {
    if (!txt || txt === &quot;--&quot;) return 0;
    const t = txt.trim().toUpperCase().replace(/,/g, &quot;&quot;);
    const mult = t.endsWith(&quot;B&quot;) ? 1e9 : t.endsWith(&quot;M&quot;) ? 1e6 : t.endsWith(&quot;K&quot;) ? 1e3 : 1;
    return Math.round(parseFloat(t) * mult) || 0;
  };

  const parseDuration = (txt) =&gt; {
    if (!txt || txt === &quot;--&quot;) return 0;
    const parts = txt.split(&quot;:&quot;).map(n =&gt; parseInt(n, 10) || 0);
    return parts.length === 3 ? parts[0]*3600 + parts[1]*60 + parts[2] : 
           parts.length === 2 ? parts[0]*60 + parts[1] : parts[0];
  };

  window.extractVideos = function(customOptions = {}) {
    const opts = { ...EXTRACT_CONFIG, ...customOptions };
    
    const table = Array.from(document.querySelectorAll('unified-table')).find(t =&gt; 
      t.innerText.includes('Upload Date') &amp;&amp; t.innerText.includes('Views')
    );
    if (!table) return console.error(&quot;[ERROR] No se encontr√≥ la tabla 'Video Gallery'.&quot;);

    const headerRow = table.querySelector('.unified-table-header-row') || 
                      document.querySelector('.unified-table-header-row'); // Fallback global
    
    if (!headerRow) return console.error(&quot;[ERROR] No se encontr√≥ la fila de encabezados.&quot;);

    const headerCells = Array.from(headerRow.querySelectorAll('.unified-table-cell'));
    const colMap = {};
    
    headerCells.forEach((cell, idx) =&gt; {
      const txt = cell.innerText.toLowerCase().trim();
      if (txt.includes('upload date')) colMap.upload = idx;
      else if (txt === 'views') colMap.views = idx;
      else if (txt === 'v30') colMap.v30 = idx;
      else if (txt === 'duration') colMap.duration = idx;
      else if (txt === 'platform') colMap.platform = idx;
    });

    console.log(&quot;[MAPEO] Mapeo de columnas:&quot;, colMap);

    const pinnedRows = Array.from(table.querySelectorAll('.unified-table-pinned-columns .unified-table-data-row'));
    const freeRows = Array.from(table.querySelectorAll('.unified-table-free-columns .unified-table-data-row'));
    
    const rowCount = Math.min(pinnedRows.length, freeRows.length);
    console.log(`[PROCESO] Procesando ${rowCount} videos...`);

    const data = [];

    for (let i = 0; i &lt; rowCount; i++) {
      try {
        const pRow = pinnedRows[i]; // Info fija (t√≠tulo, img, creador)
        const fRow = freeRows[i];   // M√©tricas (vistas, fecha)
        const fCells = fRow.querySelectorAll('.unified-table-cell');

        // --- Extracci√≥n Pinned ---
        const titleEl = pRow.querySelector('.name, .link-video-modal');
        const video = titleEl ? titleEl.innerText.trim() : &quot;&quot;;

        const creatorEl = pRow.querySelector('.uploader .link');
        const creator_name = creatorEl ? creatorEl.innerText.trim() : &quot;&quot;;

        const urlEl = pRow.querySelector('a.link-platform-watch-page');
        const video_url = urlEl ? urlEl.href : &quot;&quot;;

        // Extracci√≥n de IMAGEN (background-image) evitando foto de perfil
        const thumbDiv = pRow.querySelector('.video-thumbnail');
        let image_url = &quot;&quot;;
        if (thumbDiv) {
            const style = window.getComputedStyle(thumbDiv);
            const bg = style.backgroundImage; // url(&quot;...&quot;)
            const match = bg.match(/url\(['&quot;]?(https?:\/\/[^'&quot;]+)['&quot;]?\)/);
            if (match) image_url = match[1];
        }
        if (!image_url) {
          const thumbImg = pRow.querySelector('.video-thumbnail img:not([class*=&quot;creator&quot;]), img[src*=&quot;ytimg&quot;], img[src*=&quot;cdninstagram&quot;], img[src*=&quot;fbcdn&quot;]');
          image_url = thumbImg?.src || &quot;&quot;;
        }

        // Detectar plataforma por icono si no est√° en columnas
        const iconEl = pRow.querySelector('[class*=&quot;platform-identifier&quot;] i');
        let platform = iconEl ? iconEl.className.replace('icon-', '').replace('-sign', '').replace('-play', '') : &quot;&quot;;
        platform = platform ? platform.charAt(0).toUpperCase() + platform.slice(1) : &quot;&quot;;

        // --- Extracci√≥n Free ---
        const upload_date = colMap.upload !== undefined ? fCells[colMap.upload]?.innerText.trim() : &quot;&quot;;
        const views = colMap.views !== undefined ? fCells[colMap.views]?.innerText.trim() : &quot;0&quot;;
        const v30 = colMap.v30 !== undefined ? fCells[colMap.v30]?.innerText.trim() : &quot;0&quot;;
        const duration = colMap.duration !== undefined ? fCells[colMap.duration]?.innerText.trim() : &quot;&quot;;
        
        // Si hay columna explicita de plataforma, √∫sala
        if (colMap.platform !== undefined) {
            const pText = fCells[colMap.platform]?.innerText.trim();
            if (pText) platform = pText;
        }

        const row = {
          video, creator_name, video_url, image_url, platform, upload_date, 
          views, v30, duration
        };

        if (opts.normalizeNumbers) {
          row.views_num = parseViews(views);
          row.v30_num = parseViews(v30);
          row.duration_sec = parseDuration(duration);
        }

        data.push(row);
      } catch (err) {
        console.warn(`Error en fila ${i}`, err);
      }
    }

    // 4. Generar CSV
    if (data.length &gt; 0) {
      const headers = Object.keys(data[0]);
      const csvContent = [
        headers.map(csvEscape).join(&quot;,&quot;),
        ...data.map(row =&gt; headers.map(k =&gt; csvEscape(row[k])).join(&quot;,&quot;))
      ].join(&quot;\n&quot;);

      // Descargar
      if (opts.downloadFile) {
        const blob = new Blob([&quot;\ufeff&quot; + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement(&quot;a&quot;);
        const dateStr = new Date().toISOString().replace(/[:T]/g, '-').slice(0, 19);
        link.href = URL.createObjectURL(blob);
        link.download = `${opts.fileNamePrefix}_${dateStr}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
      
      // Copiar al portapapeles
      navigator.clipboard.writeText(csvContent).then(() =&gt; console.log(&quot;[CLIPBOARD] CSV copiado al portapapeles.&quot;));
    }

    console.log(`[OK] ${data.length} videos extra√≠dos exitosamente.`);
    return data;
  };

  console.log(&quot;[OK] Script Extractor cargado. Escribe: extractVideos();&quot;);
})();
</code></pre>
<hr />
<p><a id="opcion-b-todo-en-uno"></a></p>
<h2 id="opcion-b-todo-en-uno-pegar-y-listo">üÖ±Ô∏è Opcion B: todo en uno (pegar y listo)</h2>
<pre><code class="language-js">(async () =&gt; {
  console.log(&quot;[START] EXTRACTOR TUBLAB v3.1 - FIXED&quot;);
  console.log(&quot;=&quot;.repeat(60));

  const CONFIG = {
    maxClicks: 500,
    delayMs: 6000,
    delayJitterMs: 400,
    finalDelay: 3000,
    downloadFile: true,
    normalizeNumbers: true
  };

  const sleep = ms =&gt; new Promise(r =&gt; setTimeout(r, ms));
  const pad = n =&gt; String(n).padStart(2, &quot;0&quot;);
  const generateFileName = () =&gt; {
    const now = new Date();
    return `TubLab_${String(now.getFullYear()).slice(-2)}_${pad(now.getMonth() + 1)}_${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}.csv`;
  };
  const parseViews = txt =&gt; {
    if (!txt || txt === &quot;--&quot;) return 0;
    const t = txt.trim().toUpperCase().replace(/,/g, &quot;&quot;);
    if (t.endsWith(&quot;B&quot;)) return Math.round(parseFloat(t) * 1e9);
    if (t.endsWith(&quot;M&quot;)) return Math.round(parseFloat(t) * 1e6);
    if (t.endsWith(&quot;K&quot;)) return Math.round(parseFloat(t) * 1e3);
    return Math.round(parseFloat(t)) || 0;
  };
  const durationToSeconds = d =&gt; {
    if (!d || d === &quot;--&quot;) return 0;
    const parts = d.split(&quot;:&quot;).map(n =&gt; parseInt(n, 10) || 0);
    if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
    if (parts.length === 2) return parts[0] * 60 + parts[1];
    return parts[0] || 0;
  };

  function findLoadMoreButton() {
    const selectors = [
      '.button.full-width[ng-click*=&quot;loadMore&quot;]',
      '.load-more .button[ng-click*=&quot;loadMore&quot;]',
      '.load-more .button',
      '[ng-click*=&quot;loadMore&quot;]',
      null
    ];
    for (const sel of selectors) {
      if (sel === null) {
        const candidates = Array.from(document.querySelectorAll('button, div.button, a.button'));
        const btn = candidates.find(el =&gt; /load\s*more/i.test(el.innerText || &quot;&quot;) &amp;&amp; el.offsetParent !== null);
        if (btn) return btn;
      } else {
        const btn = document.querySelector(sel);
        if (btn &amp;&amp; btn.offsetParent !== null) return btn;
      }
    }
    return null;
  }

  // FASE 1
  console.log(`\n[FASE1] Cargando videos (max ${CONFIG.maxClicks} clics)...`);
  let clicks = 0;
  for (let i = 0; i &lt; CONFIG.maxClicks; i++) {
    const btn = findLoadMoreButton();
    if (!btn) {
      console.log(&quot;[OK] No hay mas boton 'Load more' visible&quot;);
      break;
    }
    btn.scrollIntoView({ block: &quot;center&quot;, behavior: &quot;instant&quot; });
    btn.click();
    clicks++;
    if (clicks % 10 === 0) console.log(`   ... ${clicks} clics`);
    const jitter = Math.floor(Math.random() * (CONFIG.delayJitterMs + 1));
    await sleep(CONFIG.delayMs + jitter);
  }
  console.log(`[OK] Total clics: ${clicks}`);
  await sleep(CONFIG.finalDelay);

  // FASE 2
  console.log(&quot;\n[FASE2] Buscando tabla...&quot;);
  const table = Array.from(document.querySelectorAll('unified-table'))
    .find(t =&gt; /Upload Date/i.test(t.innerText) &amp;&amp; /Views/i.test(t.innerText));
  if (!table) return console.error(&quot;[ERROR] No se encontro la tabla&quot;);
  console.log(&quot;[OK] Tabla encontrada&quot;);

  // FASE 3 (header corregido)
  console.log(&quot;\n[FASE3] Detectando columnas...&quot;);
  const floatingHeader = table.querySelector('.unified-table-floating-header');
  const headerRow = floatingHeader?.querySelector('.unified-table-header-row') ||
                    floatingHeader?.querySelector('.unified-table-row');
  if (!headerRow) {
    console.error(&quot;[ERROR] No se encontro el header row&quot;);
    console.log(&quot;[DEBUG] floatingHeader:&quot;, floatingHeader);
    return;
  }
  const headerCells = Array.from(headerRow.querySelectorAll('.unified-table-header-cell, .unified-table-cell'));
  const colMap = {};
  headerCells.forEach((cell, idx) =&gt; {
    const t = (cell.innerText || &quot;&quot;).trim().toLowerCase();
    console.log(`   [${idx}] &quot;${t}&quot;`);
    if (/upload\s*date/i.test(t)) colMap.uploadDate = idx;
    else if (/^views$/i.test(t)) colMap.views = idx;
    else if (/^v30$/i.test(t)) colMap.v30 = idx;
    else if (/duration/i.test(t)) colMap.duration = idx;
    else if (/platform/i.test(t)) colMap.platform = idx;
  });
  console.log(&quot;[OK] Mapeo:&quot;, colMap);

  // FASE 4
  console.log(&quot;\n[FASE4] Extrayendo datos...&quot;);
  const pRows = Array.from(table.querySelectorAll('.unified-table-pinned-columns .unified-table-data-row'));
  const fRows = Array.from(table.querySelectorAll('.unified-table-free-columns .unified-table-data-row'));
  const rowCount = Math.min(pRows.length, fRows.length);
  if (!rowCount) return console.error(&quot;[ERROR] No hay filas&quot;);
  console.log(`   Procesando ${rowCount} filas...`);

  if (fRows.length &gt; 0) {
    const firstRowCells = Array.from(fRows[0].querySelectorAll('.unified-table-cell'));
    console.log(&quot;[DEBUG] Primera fila FREE:&quot;);
    firstRowCells.forEach((c, i) =&gt; console.log(`   [${i}] &quot;${(c.innerText || &quot;&quot;).trim()}&quot;`));
  }

  const data = [];
  let errors = 0;
  for (let i = 0; i &lt; rowCount; i++) {
    try {
      const pRow = pRows[i];
      const fRow = fRows[i];
      const cells = Array.from(fRow.querySelectorAll('.unified-table-cell'));

      const titleEl = pRow.querySelector('.name, a.link-video-modal, .video-lockup .name');
      const video = (titleEl?.innerText || &quot;&quot;).trim();

      const uploaderEl = pRow.querySelector('.uploader');
      const creator_name = (uploaderEl?.innerText || &quot;&quot;).replace(/^\s*by\s*/i, &quot;&quot;).trim();

      const videoUrlEl = pRow.querySelector('a.link-platform-watch-page');
      const video_url = videoUrlEl?.href || &quot;&quot;;

      let image_url = &quot;&quot;;
      const thumbDiv = pRow.querySelector('.video-thumbnail');
      if (thumbDiv) {
        const bg = window.getComputedStyle(thumbDiv).backgroundImage;
        const match = bg.match(/url\([&quot;']?(https?:\/\/[^&quot;')]+)[&quot;']?\)/);
        if (match) image_url = match[1];
      }
      if (!image_url) {
        const thumbImg = pRow.querySelector('.video-thumbnail img:not([class*=&quot;creator&quot;]), img[src*=&quot;ytimg&quot;], img[src*=&quot;cdninstagram&quot;], img[src*=&quot;fbcdn&quot;]');
        image_url = thumbImg?.src || &quot;&quot;;
      }

      const platformEl = pRow.querySelector('[class*=&quot;platform-identifier&quot;] i, [class*=&quot;platform-&quot;]');
      const platformClass = platformEl?.className || &quot;&quot;;
      let platformDetected = &quot;&quot;;
      if (/instagram/i.test(platformClass)) platformDetected = &quot;Instagram&quot;;
      else if (/youtube/i.test(platformClass)) platformDetected = &quot;YouTube&quot;;
      else if (/tiktok/i.test(platformClass)) platformDetected = &quot;TikTok&quot;;
      else if (/facebook/i.test(platformClass)) platformDetected = &quot;Facebook&quot;;

      const getCell = key =&gt; {
        if (colMap[key] === undefined) return &quot;&quot;;
        const cell = cells[colMap[key]];
        return (cell?.innerText || &quot;&quot;).trim();
      };

      const upload_date = getCell(&quot;uploadDate&quot;);
      const views = getCell(&quot;views&quot;);
      const v30 = getCell(&quot;v30&quot;);
      const duration = getCell(&quot;duration&quot;);
      const platformFromCol = getCell(&quot;platform&quot;);
      const platform = platformFromCol || platformDetected;

      const row = { video, creator_name, video_url, image_url, upload_date, views, v30, duration, platform };
      if (CONFIG.normalizeNumbers) {
        row.views_num = parseViews(views);
        row.v30_num = parseViews(v30);
        row.duration_sec = durationToSeconds(duration);
      }
      data.push(row);
    } catch (err) {
      errors++;
      console.warn(`[WARN] Error fila ${i + 1}: ${err.message}`);
    }
  }

  console.log(`[OK] Extraidos: ${data.length} videos`);
  if (errors) console.warn(`[WARN] Errores: ${errors}`);
  if (data.length &gt; 0) {
    console.log(&quot;\n[MUESTRA] Primeros 3 registros:&quot;);
    console.table(data.slice(0, 3));
  }
  if (!data.length) return console.error(&quot;[ERROR] No se extrajo nada&quot;);

  // FASE 5
  console.log(&quot;\n[FASE5] Generando CSV...&quot;);
  const csvEscape = v =&gt; '&quot;' + String(v ?? &quot;&quot;).replace(/&quot;/g, '&quot;&quot;') + '&quot;';
  const headers = Object.keys(data[0]);
  const csvLines = [
    headers.map(csvEscape).join(&quot;,&quot;),
    ...data.map(row =&gt; headers.map(h =&gt; csvEscape(row[h])).join(&quot;,&quot;))
  ];
  const csv = &quot;\ufeff&quot; + csvLines.join(&quot;\n&quot;);

  try {
    await navigator.clipboard.writeText(csv);
    console.log(&quot;[OK] Copiado al portapapeles&quot;);
  } catch { console.warn(&quot;[WARN] No se pudo copiar&quot;); }

  if (CONFIG.downloadFile) {
    const fileName = generateFileName();
    const blob = new Blob([csv], { type: &quot;text/csv;charset=utf-8;&quot; });
    const url = URL.createObjectURL(blob);
    const a = document.createElement(&quot;a&quot;);
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    console.log(`[OK] Descargado: ${fileName}`);
  }

  console.log(&quot;\n&quot; + &quot;=&quot;.repeat(60));
  console.log(`Videos: ${data.length} | Clics: ${clicks} | Errores: ${errors}`);
  console.log(&quot;=&quot;.repeat(60));

  return data;
})();
</code></pre>
<p>Columnas generadas:</p>
<ul>
<li>Basicas: <code>video</code>, <code>creator_name</code>, <code>video_url</code>, <code>image_url</code>, <code>upload_date</code>, <code>views</code>, <code>v30</code>, <code>duration</code>, <code>platform</code></li>
<li>Con <code>normalizeNumbers: true</code>: <code>views_num</code>, <code>v30_num</code>, <code>duration_sec</code></li>
</ul>
<hr />
<p><a id="diagnostico-rapido"></a></p>
<h2 id="diagnostico-rapido-si-deja-de-funcionar">ü©∫ Diagnostico rapido (si deja de funcionar)</h2>
<p>Ejecuta este bloque para ver indices y valores de la primera fila; con esa info ajustas los selectores.</p>
<pre><code class="language-js">(() =&gt; {
  console.log(&quot;[Diag] Columnas FREE&quot;);
  const table = Array.from(document.querySelectorAll('unified-table'))
    .find(t =&gt; /Upload Date/i.test(t.innerText) &amp;&amp; /Views/i.test(t.innerText));
  if (!table) return console.warn(&quot;Tabla no encontrada&quot;);

  const freeGroup = table.querySelector('.unified-table-free-columns');
  const floatingHeader = table.querySelector('.unified-table-floating-header, .unified-table-free-columns-wrapper');
  const headerRow = floatingHeader?.querySelector('.unified-table-row, .unified-table-header-row') || floatingHeader || freeGroup;
  if (!headerRow) return console.warn(&quot;Header no encontrado&quot;);

  const headerCells = Array.from(headerRow.querySelectorAll('.unified-table-header-cell, [class*=\&quot;header-cell\&quot;], .unified-table-cell'));
  const indices = {};
  headerCells.forEach((cell, i) =&gt; {
    const txt = (cell.innerText || &quot;&quot;).trim();
    console.log(i, `&quot;${txt}&quot;`);
    if (/upload.*date/i.test(txt)) indices.uploadDate = i;
    if (/^views$/i.test(txt)) indices.views = i;
    if (/^v30$/i.test(txt)) indices.v30 = i;
    if (/duration/i.test(txt)) indices.duration = i;
    if (/platform/i.test(txt)) indices.platform = i;
  });
  console.log(&quot;Indices detectados:&quot;, indices);

  const freeRows = table.querySelectorAll('.unified-table-free-columns .unified-table-data-row');
  const pinnedRows = table.querySelectorAll('.unified-table-pinned-columns .unified-table-data-row');
  if (!freeRows.length || !pinnedRows.length) return console.warn(&quot;Sin filas de datos&quot;);

  const cells = Array.from(freeRows[0].querySelectorAll('.unified-table-cell, [class*=\&quot;cell\&quot;]'));
  console.log(&quot;Fila 1 (free):&quot;, cells.map(c =&gt; (c.innerText || &quot;&quot;).trim()));
  const titleEl = pinnedRows[0].querySelector('.name, a.link-video-modal, .video-lockup .name');
  console.log(&quot;Titulo (pinned):&quot;, titleEl?.innerText?.trim());
})();
</code></pre>
<hr />
<p><a id="guia-rapida-de-uso"></a></p>
<h2 id="guia-rapida-de-uso">‚ö° Guia rapida de uso</h2>
<ul>
<li>Abre DevTools (F12) -&gt; pesta√±a Console.</li>
<li>Escribe <code>allow pasting</code> y Enter.</li>
<li>Pega el bloque completo (Opcion A o B). Copia solo lo que est√° dentro del bloque <code>js ... </code>.</li>
<li>Si usas <strong>Opcion A</strong>: ejecuta <code>await autoLoadMore();</code> y luego <code>extractVideos();</code> (el <code>await</code> es necesario porque la funci√≥n es async).</li>
<li>Si usas <strong>Opcion B</strong>: con pegar el bloque basta; el script corre solo (ya incluye los <code>await</code> internos).</li>
</ul>
<hr />
<p><a id="solucion-de-problemas"></a></p>
<h2 id="solucion-de-problemas">üõ†Ô∏è Solucion de problemas</h2>
<table>
<thead>
<tr>
<th>Problema</th>
<th>Solucion</th>
</tr>
</thead>
<tbody>
<tr>
<td>Sale <code>undefined</code> al pegar</td>
<td>Ejecuta la funcion: <code>await autoLoadMore();</code> o <code>extractVideos();</code></td>
</tr>
<tr>
<td>Error <code>Unexpected identifier 'generadas'</code></td>
<td>Copia solo el bloque de codigo (entre <code>js ... </code>), sin el texto de la gu√≠a</td>
</tr>
<tr>
<td>No clickea el boton</td>
<td>Revisa que la consola este en el frame &quot;top&quot; y aumenta <code>delayMs</code> si la pagina es lenta</td>
</tr>
<tr>
<td>No encuentra la tabla</td>
<td>Asegurate de estar en &quot;Video Gallery&quot;</td>
</tr>
<tr>
<td>No copia al portapapeles</td>
<td>Descarga el CSV (se guardara igual)</td>
</tr>
<tr>
<td>Demasiados clics</td>
<td>Baja <code>maxClicks</code> o usa filtros en TubLab</td>
</tr>
<tr>
<td>Caracteres raros al abrir el CSV en Excel</td>
<td>El CSV lleva BOM UTF-8; si aun asi pasa, usa &quot;Datos &gt; Obtener datos &gt; Desde texto/CSV&quot; y elige UTF-8.</td>
</tr>
</tbody>
</table>
<hr />
<p><a id="notas-de-mantenimiento"></a></p>
<h2 id="notas-de-mantenimiento">üìù Notas de mantenimiento</h2>
<ul>
<li>Si cambian los headers, revisa el bloque de diagnostico y ajusta el mapeo de columnas.</li>
<li>Si cambian los estilos de plataforma, ajusta la deteccion de <code>platform</code>.</li>
<li>Si cambian el boton de carga, actualiza el selector <code>.button.full-width[ng-click*=&quot;loadMore&quot;]</code> o agrega otro a la lista.</li>
</ul>

    </article>
  </div>
  <script>
    (() => {
      async function copyText(text, btn) {
        try {
          if (navigator.clipboard?.writeText) {
            await navigator.clipboard.writeText(text);
          } else {
            const area = document.createElement("textarea");
            area.value = text;
            document.body.appendChild(area);
            area.select();
            document.execCommand("copy");
            document.body.removeChild(area);
          }
          btn.textContent = "Copiado";
          btn.classList.add("copied");
          setTimeout(() => {
            btn.textContent = "Copiar";
            btn.classList.remove("copied");
          }, 1600);
        } catch (err) {
          btn.textContent = "Error";
          console.error("No se pudo copiar", err);
          setTimeout(() => (btn.textContent = "Copiar"), 1600);
        }
      }

      function addCopyButtons() {
        document.querySelectorAll("pre").forEach((pre, idx) => {
          if (pre.querySelector(".copy-btn")) return;
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "copy-btn";
          btn.textContent = "Copiar";
          btn.setAttribute("aria-label", "Copiar codigo");
          btn.addEventListener("click", () => {
            const code = pre.querySelector("code");
            const text = (code ? code.innerText : pre.innerText).replace(/\u00A0/g, " ");
            copyText(text, btn);
          });
          pre.appendChild(btn);
        });
      }

      function escapeHtml(txt) {
        return txt
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      function highlightJS(txt) {
        const token = /(\\/\\/.*$)|(['`](?:\\\\.|[^\\\\])*?['`]|\"(?:\\\\.|[^\\\\\"])*?\")|\\b\\d+(?:\\.\\d+)?\\b|\\b(?:const|let|var|function|return|if|else|for|while|await|async|break|continue|try|catch|throw|new|class|extends|switch|case|default|import|from|export|typeof|instanceof)\\b|\\b(?:window|document|console|navigator|Math|Date|Array|Object|Promise)\\b|=>|[=+\\-/*]{1,2}|\\b[a-zA-Z_$][\\w$]*(?=\\s*\\()/gm;
        let out = "";
        let last = 0;
        let m;
        while ((m = token.exec(txt)) !== null) {
          out += escapeHtml(txt.slice(last, m.index));
          const match = m[0];
          let cls = "";
          if (m[1]) cls = "tok-cmt";
          else if (m[2]) cls = "tok-str";
          else if (/^\\d/.test(match)) cls = "tok-num";
          else if (/^(const|let|var|function|return|if|else|for|while|await|async|break|continue|try|catch|throw|new|class|extends|switch|case|default|import|from|export|typeof|instanceof)$/.test(match)) cls = "tok-kw";
          else if (/^(window|document|console|navigator|Math|Date|Array|Object|Promise)$/.test(match)) cls = "tok-var";
          else if (match === "=>" || /^[=+\\-/*]+$/.test(match)) cls = "tok-op";
          else cls = "tok-fn";
          out += `<span class="${cls}">${escapeHtml(match)}</span>`;
          last = token.lastIndex;
        }
        out += escapeHtml(txt.slice(last));
        return out;
      }

      function highlightAll() {
        document.querySelectorAll("pre code").forEach((code) => {
          if (code.dataset.highlighted) return;
          const lang = code.className || "";
          const txt = code.textContent;
          if (/language-js|javascript/i.test(lang)) {
            code.innerHTML = highlightJS(txt);
          } else {
            code.innerHTML = escapeHtml(txt);
          }
          code.dataset.highlighted = "1";
        });
      }

      window.addEventListener("DOMContentLoaded", () => {
        highlightAll();
        addCopyButtons();
      });
    })();
  </script>
</body>
</html>
